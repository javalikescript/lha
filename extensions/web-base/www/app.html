<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>App</title>
  <link rel="stylesheet" href="app.css">
  <link rel="stylesheet" href="static/fa/css/all.min.css">
  <script src="static/promise.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="static/fetch.umd.js" type="text/javascript" charset="utf-8"></script>
  <script src="static/v/vue.min.js" type="text/javascript" charset="utf-8"></script>
  <script src="app/utils.js" type="text/javascript" charset="utf-8"></script>
</head>
<body class="theme_boot">
<div class="splash">
  Loading...
  <!--
    <i class="fas fa-spinner fa-spin"></i>
  -->
</div>
<!-- v-if="show" class="toaster" -->
<div id="toaster" :class="['toaster', show ? '' : 'hide']">{{message}}</div>
<!-- Custom pages used by components -->
<div id="custom-pages" class="pages">
  <!--
    confirmation dialog
  -->
  <app-dialog id="confirmation" title="Confirm">
    <template slot="bar-right">
      <button v-on:click="onCancel()"><i class="fa fa-window-close"></i></button>
    </template>
    <page-article>
      <p>{{ message }}</p>
      <button v-on:click="onConfirm()"><i class="fas fa-check"></i>&nbsp;Confirm</button>
      <button v-on:click="onCancel()"><i class="fas fa-times"></i>&nbsp;Cancel</button>
    </page-article>
  </app-dialog>
  <!--
    default menu
  -->
  <app-menu id="menu" title="Menu" home-page="home">
    <article class="content">
      <ul>
        <li v-for="page in sortedPages" v-on:click="app.toPage(page.id)" v-if="app.page !== page.id">{{ page.name }}</li>
      </ul>
    </article>
  </app-menu>
  <!--
    things
  -->
  <app-page id="things" title="Things">
    <template slot="bar-right">
      <button v-on:click="app.toPage('addThings')"><i class="fa fa-plus"></i></button>
      <button v-if="edit" v-on:click="onSave" title="Save"><i class="far fa-save"></i></button>
      <button v-on:click="onShow" title="Refresh"><i class="fas fa-sync"></i></button>
      <button v-on:click="edit = !edit" title="Edit"><i :class="['fas', edit ? 'fa-eye' : 'fa-edit']"></i></button>
    </template>
    <article class="cards">
      <div class="card" v-for="thing in things">
        <div class="bar">
          <div>
            <p>{{ thing.title + (thing.extensionId in extensionsById ? (' (' + extensionsById[thing.extensionId].name + ')') : '') }}</p>
          </div>
          <div>
            <button v-on:click="app.toPage('thing', thing.thingId)"><i class="fas fa-info"></i>&nbsp;Details</button>
          </div>
        </div>
        <p>{{ thing.description }}</p>
        <div class="bar">
          <div><p v-if="edit">
            <label class="switch"><input type="checkbox" v-model="thing.archiveData" /><span class="slider"></span></label>&nbsp;Archive Data
          </p></div>
          <div>
            <p>{{ (thing.thingId in propertiesById ? (propertiesById[thing.thingId].value + ' ' + propertiesById[thing.thingId].unit) : '') }}</p>
          </div>
        </div>
      </div>
      <section v-if="edit">
        <!-- fas fa-history fas fa-database -->
        <button v-on:click="onArchiveAll()"><i class="fas fa-history"></i>&nbsp;Archive All</button>
        <button v-on:click="onRemoveAll()"><i class="fa fa-trash"></i>&nbsp;Disable All</button>
      </section>
    </article>
  </app-page>
  <app-page id="thing" title="Thing">
    <template slot="bar-right">
      <button v-if="edit" v-on:click="onSave().then(function(){ edit = false; })" title="Save"><i class="far fa-save"></i></button>
      <button v-on:click="onShow()" title="Refresh"><i class="fas fa-sync"></i></button>
      <!--
        <button v-on:click="refreshThingDescription()" title="Refresh Description"><i class="fas fa-redo"></i></button>
      -->
      <button v-on:click="disableThing().then(function(){ app.back(); })" title="Disable"><i class="fa fa-trash"></i></button>
      <button v-on:click="onEdit()" title="Edit"><i :class="['fas', edit ? 'fa-eye' : 'fa-edit']"></i></button>
    </template>
    <article class="cards">
      <div class="card">
        <p>{{ thing.title }}</p>
        <p>{{ thing.description }}</p>
      </div>
      <div class="card" v-for="(property, name) in thing.properties">
        <div class="bar">
          <p>{{ property.title }}</p>
          <div>
            <div v-if="!edit || property.readOnly">
              <p v-if="name in properties"><b>{{ properties[name] }}</b>&nbsp;<span><i>{{ property.unit }}</i></span></p>
              <p v-else><i>No value</i></p>
            </div>
            <div v-else>
              <input v-if="property.type === 'string'" v-model="props[name]" type="text" placeholder="String Value">
              <input v-if="(property.type === 'number') || (property.type === 'integer')" v-model="props[name]" number type="number" placeholder="Number Value">
              <label v-if="property.type === 'boolean'" class="switch"><input type="checkbox" v-model="props[name]" /><span class="slider"></span></label>
            </div>
          </div>
          <div>
            <!-- TODO also check thing.archiveData -->
            <button v-if="!property.configuration" v-on:click="openHistoricalData(name)"><i class="fas fa-chart-line"></i>&nbsp;History</button>
          </div>
        </div>
        <p>{{ property.description }}</p>
      </div>
    </article>
  </app-page>
  <app-page id="addThings" title="Add Things">
    <template slot="bar-right">
      <button v-on:click="onSave().then(function(){ app.replacePage('things'); })" title="Enable Selected Things"><i class="far fa-save"></i></button>
      <button v-on:click="onShow()" title="Refresh"><i class="fas fa-sync"></i></button>
    </template>
    <article class="cards">
      <div class="card" v-for="thing in things">
        <div class="bar">
          <p>{{ thing.title }}</p>
          <label class="switch" title="Enable"><input type="checkbox" v-model="thing.toAdd" /><span class="slider"></span></label>
        </div>
        <p>{{ thing.description }}</p>
      </div>
      <section>
        <button v-on:click="onAddAll().then(function(){ app.replacePage('things'); })"><i class="fa fa-plus"></i>&nbsp;Enable All</button>
        <button v-on:click="app.back()">Cancel</button>
      </section>
    </article>
  </app-page>
  <!--
    extensions
  -->
  <app-page id="extensions" title="Extensions">
    <template slot="bar-right">
      <button v-on:click="onShow()" title="Refresh"><i class="fas fa-sync"></i></button>
      <button v-on:click="app.toPage('addExtensions')" title="Add"><i class="fa fa-plus"></i></button>
    </template>
    <article class="cards">
      <div class="card" v-for="extension in extensions" v-if="extension.active">
        <div class="bar">
          <p>{{ extension.name }}</p>
          <div>
            <button v-on:click="pollExtension(extension)"><i class="far fa-bell"></i>&nbsp;Poll</button>
            <button v-on:click="app.toPage('extension', extension.id)"><i class="fas fa-cog"></i>&nbsp;Settings</button>
          </div>
        </div>
        <p>{{ extension.description }}</p>
      </div>
    </article>
  </app-page>
  <app-page id="extension" title="Extension">
    <template slot="bar-right">
      <button v-on:click="onShow()" title="Refresh"><i class="fas fa-sync"></i></button>
      <!-- fa fa-minus -->
      <button v-on:click="onDisable().then(function(){ app.back(); })" title="Disable"><i class="fa fa-trash"></i></button>
      <button v-on:click="onSave()" title="Save"><i class="fas fa-save"></i></button>
      <button v-on:click="onReload" title="Reload"><i class="fas fa-redo"></i></button>
    </template>
    <article class="content">
      <section>
        <p>{{ extension.info.name }}</p>
        <p>{{ extension.info.description }}</p>
        <json v-if="schema" :name="'Configuration'" :obj="extension.config" :schema="schema"></json>
      </section>
      <section>
        <button v-on:click="onSave()"><i class="far fa-save"></i>&nbsp;Save</button>
      </section>
    </article>
  </app-page>
  <app-page id="addExtensions" title="Add Extensions">
    <article class="cards">
      <div class="card" v-for="extension in extensions" v-if="! extension.active">
        <div class="bar">
          <p>{{ extension.name }}</p>
          <div>
            <button v-on:click="app.toPage('addExtension', extension.id)"><i class="fa fa-plus"></i>&nbsp;Add...</button>
          </div>
        </div>
        <p>{{ extension.description }}</p>
      </div>
    </article>
  </app-page>
  <app-page id="addExtension" title="Add Extension">
    <article class="content">
      <section>
        <p>{{ extension.info.name }}</p>
        <p>{{ extension.info.description }}</p>
        <json v-if="schema" :name="'Configuration'" :obj="extension.config" :schema="schema"></json>
      </section>
      <section>
        <button v-on:click="onAdd().then(function(){ app.replacePage('extensions'); })"><i class="fa fa-plus"></i>&nbsp;Add</button>
        <button v-on:click="app.back()">Cancel</button>
      </section>
    </article>
  </app-page>
  <!--
    Server Info
  -->
  <app-page id="engineInfo" title="Server Info">
    <template slot="bar-right">
      <button v-on:click="onShow()" title="Refresh"><i class="fas fa-sync"></i></button>
    </template>
    <page-article>
      <p>Information</p>
      <dl>
        <template v-for="(value, name) in infos">
          <dt><label>{{ name }}</label></dt>
          <dd><span>{{ value }}</span></dd>
        </template>
      </dl>
    </page-article>
  </app-page>
  <!--
    Engine Configuration
  -->
  <app-page id="engineSettings" title="Server Configuration" transition-class="hideTop">
    <template slot="bar-right">
      <button v-on:click="stopServer()" title="Stop the Server"><i class="fas fa-power-off"></i></button>
      <button v-on:click="app.toPage('engineInfo')" title="Server Information"><i class="fas fa-info"></i></button>
      <button v-on:click="onShow()" title="Refresh"><i class="fas fa-sync"></i></button>
    </template>
    <page-article>
      <json :name="'Configuration'" :obj="config" :schema="schema"></json>
      <button v-on:click="onSave()"><i class="far fa-save"></i>&nbsp;Save</button>
      <p>Backup and Restore</p>
      <button v-on:click="backup" :disabled="working"><i class="fas fa-box"></i>&nbsp;Create Backup</button>
      <a v-if="filename" :href="'/engine/tmp/' + filename" download>{{filename}}</a>
      <button v-on:click="selectFile" :disabled="working"><i class="fas fa-box-open"></i>&nbsp;Deploy Backup</button>
      <input v-on:change="uploadThenDeploy" type="file" accept=".zip" ref="uploadInput" style="display: none;" />
      <button v-on:click="stopServer()" :disabled="working"><i class="fas fa-power-off"></i>&nbsp;Stop the Server</button>
    </page-article>
  </app-page>
  <!--
    Main
  -->
  <app-page id="home" :title="title" hide-back="true">
    <template slot="bar-right">
      <button v-on:click="app.toPage('engineSettings')" title="Configuration"><i class="fas fa-cog"></i></button>
    </template>
    <article class="tiles">
      <div class="tile" v-for="page in sortedPages" v-on:click="app.toPage(page.id)">
        <span>{{ page.name }}</span>
        <p class="tile-value" v-if="page.icon"><i :class="['fas', page.icon]"></i></p>
      </div>
    </article>
  </app-page>
</div>
<!-- Simple pages loaded automatically -->
<div id="pages" class="pages">
  <app-page id="first" title="First">
    <page-article>
      <p>First content</p>
    </page-article>
  </app-page>
</div>
<div id="app"></div>
</body>
<script type="text/x-template" id="json-item-template">
  <li class="json">
    <div>
      <div>
        <span v-on:click="toggle">
          <i v-if="hasContent" :class="['fa', open ? 'fa-chevron-down' : 'fa-chevron-right']"></i>
          {{ label }}:
        </span>
        <i class="fa fa-trash" v-if="isRemovable" v-on:click="removeItem" title="Remove"></i>
        <i class="fas fa-caret-up" v-if="canMove(-1)" v-on:click="moveItem(-1)" title="Move Up"></i>
        <i class="fas fa-caret-down" v-if="canMove(1)" v-on:click="moveItem(1)" title="Move Down"></i>
      </div>
      <input v-if="hasStringValue && !hasEnumValues" v-model="value" type="text" placeholder="String Value">
      <input v-if="hasNumberValue && !hasEnumValues" v-model="value" type="number" placeholder="Number Value">
      <label v-if="hasBooleanValue" class="switch big">
        <input type="checkbox" v-model="value" />
        <span class="slider"></span>
      </label>
      <select v-if="hasEnumValues && (hasStringValue || hasNumberValue)" v-model="value">
        <option v-for="ev in enumValues" :value="ev.const">{{ev.title}}</option>
      </select>
    </div>
    <ul class="json-properties" v-show="open" v-if="hasProperties">
      <li is="json-item" v-for="n in propertyNames" :key="n" :name="n" :pobj="obj" :obj="obj[n]" :schema="schema.properties[n]" :root="root"></li>
    </ul>
    <ul class="json-items" v-show="open" v-if="isList">
      <li is="json-item" v-for="(so, i) in obj" :key="i" :name="String(i + 1)" :pobj="obj" :obj="so" :schema="schema.items" :root="root"></li>
      <li>
        <button v-on:click="addItem" title="Add Item"><i class="fa fa-plus"></i>&nbsp;Add {{ label }} Item</button>
      </li>
    </ul>
  </li>
</script>
<script type="text/x-template" id="json-template">
  <ul class="json-root">
    <json-item :name="name" :obj="obj" :schema="schema" :root="this"></json-item>
  </ul>
</script>
<script type="text/x-template" id="dialog-template" tabindex="-1">
  <section v-bind:id="id" class="page dialog" v-bind:class="{ hide: app.dialog !== id }">
    <header>
      <div />
      <h1>{{ title }}</h1>
      <div>
        <slot name="bar-right">
          <button v-on:click="app.dialog = ''"><i class="fa fa-window-close"></i></button>
        </slot>
      </div>
    </header>
    <slot>Article</slot>
  </section>
</script>
<script type="text/x-template" id="menu-template" tabindex="-1">
  <section v-bind:id="id" class="menu" v-bind:class="{ hideLeft: app.menu !== id }">
    <header>
      <div>
        <button v-on:click="app.menu = ''"><i class="fa fa-window-close"></i></button>
        <button v-on:click="app.toPage(homePage)" v-if="homePage && (app.page !== homePage)"><i class="fas fa-home"></i></button>
      </div>
      <h1>{{ title }}</h1><div />
    </header>
    <slot>Article</slot>
  </section>
</script>
<script type="text/x-template" id="page-template">
  <section v-bind:id="id" v-bind:class="[{page: true}, app.page === id ? '' : transitionClass]" tabindex="-1">
    <header>
      <div>
        <slot name="bar-left">
          <button v-on:click="app.menu = menu" v-if="menu"><i class="fa fa-bars"></i></button>
          <button v-on:click="app.back()" v-if="!hideBack"><i class="fa fa-chevron-left"></i></button>
          <button v-on:click="app.toPage(homePage)" v-if="homePage"><i class="fas fa-home"></i></button>
        </slot>
      </div>
      <slot name="bar-middle">
        <h1>{{ title }}</h1>
      </slot>
      <div>
        <slot name="bar-right"></slot>
      </div>
    </header>
    <slot>Article</slot>
  </section>
</script>
<script src="static/moment.js" type="text/javascript"></script>
<script src="static/chart/Chart.min.js"></script>
<script type="text/javascript">
//<!--
  if (navigator.userAgent.indexOf('Edge') >= 0) {
    console.log('Edge detected');
    var rawFetch = fetch;
    fetch = function(input, init) {
      if (init === undefined) {
        init = {};
      }
      if (typeof init === 'object') {
        if (!init.credentials) {
          init.credentials = 'include';
        }
      }
      return rawFetch(input, init);
    };
  }
//-->
</script>
<script src="static/amdimpl.js" type="text/javascript" charset="utf-8"></script>
<!-- blockly for web-script extension -->
<script src="static/blockly/blockly_compressed.js"></script>
<script src="static/blockly/blocks_compressed.js"></script>
<script src="static/blockly/javascript_compressed.js"></script>
<script src="static/blockly/lua_compressed.js"></script>
<script src="static/blockly/msg/js/en.js"></script>
<!-- boot web base app -->
<script src="app/app.js" type="text/javascript" charset="utf-8"></script>
<script src="app/json.js" type="text/javascript" charset="utf-8"></script>
<script src="app/extensions.js" type="text/javascript" charset="utf-8"></script>
<script src="app/things.js" type="text/javascript" charset="utf-8"></script>
<script src="app/boot.js" type="text/javascript" charset="utf-8"></script>
</html>